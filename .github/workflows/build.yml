name: Build Word Autofiller EXE

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
    
    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: üî® Build EXE with PyInstaller
      run: |
        pyinstaller --onefile --windowed --icon=icon.ico --add-data "words.json;." --name "WordAutofiller" main.py
    
    - name: üìä Get File Info
      id: fileinfo
      shell: pwsh
      run: |
        $fileSize = (Get-Item "dist/WordAutofiller.exe").Length
        $fileSizeMB = [math]::Round($fileSize / 1MB, 2)
        echo "size=$fileSizeMB MB" >> $env:GITHUB_OUTPUT
        echo "hash=$(Get-FileHash -Algorithm SHA256 'dist/WordAutofiller.exe').Hash" >> $env:GITHUB_OUTPUT
    
    - name: üì§ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: WordAutofiller-Windows
        path: dist/WordAutofiller.exe
        retention-days: 30
    
    - name: üéØ Send to Discord
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      shell: pwsh
      run: |
        $embed = @{
          title = "‚úÖ Word Autofiller Build Complete"
          description = "New EXE has been built successfully!"
          color = 3066993
          fields = @(
            @{
              name = "üì¶ Version"
              value = "${{ github.sha }}"
              inline = $true
            }
            @{
              name = "üî® Built By"
              value = "${{ github.actor }}"
              inline = $true
            }
            @{
              name = "üìä File Size"
              value = "${{ steps.fileinfo.outputs.size }}"
              inline = $true
            }
            @{
              name = "üîê SHA256"
              value = "``${{ steps.fileinfo.outputs.hash }}``"
              inline = $false
            }
            @{
              name = "‚è∞ Build Time"
              value = (Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
              inline = $false
            }
          )
          footer = @{
            text = "Word Autofiller Pro"
          }
        }
        
        $payload = @{
          username = "Build Bot"
          embeds = @($embed)
        } | ConvertTo-Json -Depth 10
        
        Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -Body $payload -ContentType 'application/json'
        
        # Upload file to Discord
        $boundary = [System.Guid]::NewGuid().ToString()
        $filePath = "dist/WordAutofiller.exe"
        $fileBytes = [System.IO.File]::ReadAllBytes($filePath)
        $fileName = [System.IO.Path]::GetFileName($filePath)
        
        $bodyLines = @(
          "--$boundary",
          "Content-Disposition: form-data; name=`"file`"; filename=`"$fileName`"",
          "Content-Type: application/octet-stream",
          "",
          [System.Text.Encoding]::GetEncoding("iso-8859-1").GetString($fileBytes),
          "--$boundary--"
        )
        
        $body = $bodyLines -join "`r`n"
        
        Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -ContentType "multipart/form-data; boundary=$boundary" -Body $body
