name: Build Windows EXE

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install keyboard pyautogui pytesseract pillow opencv-python pyttsx3 pyinstaller requests
    
    - name: Build EXE
      run: |
        pyinstaller --onefile --windowed --icon=icon.ico --add-data "words.json;." --name "WordAutofiller" main.py
    
    - name: Get file info
      id: fileinfo
      shell: pwsh
      run: |
        $fileSize = (Get-Item "dist/WordAutofiller.exe").Length
        $fileSizeMB = [math]::Round($fileSize / 1MB, 2)
        echo "size=$fileSizeMB" >> $env:GITHUB_OUTPUT
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: WordAutofiller-Windows
        path: dist/WordAutofiller.exe
        retention-days: 90
    
    - name: Send to Discord
      if: ${{ secrets.DISCORD_WEBHOOK != '' }}
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      shell: pwsh
      run: |
        try {
          $webhook = $env:DISCORD_WEBHOOK
          
          if ([string]::IsNullOrWhiteSpace($webhook)) {
            Write-Host "‚ö†Ô∏è Discord webhook not configured - skipping"
            exit 0
          }
          
          Write-Host "üì§ Sending to Discord..."
          
          # Send embed
          $embed = @{
            title = "‚úÖ WordAutofiller Build Complete"
            description = "New Windows EXE has been built successfully!"
            color = 3066993
            fields = @(
              @{
                name = "üì¶ Version"
                value = "${{ github.sha }}".Substring(0,7)
                inline = $true
              }
              @{
                name = "üî® Built by"
                value = "${{ github.actor }}"
                inline = $true
              }
              @{
                name = "üìä Size"
                value = "${{ steps.fileinfo.outputs.size }} MB"
                inline = $true
              }
              @{
                name = "‚è∞ Time"
                value = (Get-Date -Format "yyyy-MM-dd HH:mm UTC")
                inline = $false
              }
            )
            footer = @{
              text = "Word Autofiller Pro"
            }
            timestamp = (Get-Date).ToUniversalTime().ToString("o")
          }
          
          $payload = @{
            username = "Build Bot"
            embeds = @($embed)
          } | ConvertTo-Json -Depth 10
          
          Invoke-RestMethod -Uri $webhook -Method Post -Body $payload -ContentType 'application/json'
          Write-Host "‚úÖ Embed sent"
          
          # Upload file
          $filePath = "dist/WordAutofiller.exe"
          
          if (Test-Path $filePath) {
            Write-Host "üìé Uploading file..."
            
            $fileBytes = [System.IO.File]::ReadAllBytes($filePath)
            $fileName = [System.IO.Path]::GetFileName($filePath)
            
            $boundary = [System.Guid]::NewGuid().ToString()
            $LF = "`r`n"
            
            $bodyLines = (
              "--$boundary",
              "Content-Disposition: form-data; name=`"file`"; filename=`"$fileName`"",
              "Content-Type: application/octet-stream$LF",
              [System.Text.Encoding]::GetEncoding('iso-8859-1').GetString($fileBytes),
              "--$boundary--$LF"
            ) -join $LF
            
            Invoke-RestMethod -Uri $webhook -Method Post -ContentType "multipart/form-data; boundary=$boundary" -Body $bodyLines
            Write-Host "‚úÖ File uploaded to Discord"
          } else {
            Write-Host "‚ùå File not found: $filePath"
          }
          
        } catch {
          Write-Host "‚ö†Ô∏è Discord upload failed: $_"
          Write-Host "But build was successful! Download from Artifacts."
        }
